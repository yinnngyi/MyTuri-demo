{"mappings":"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","sources":["<anon>","src/js/main.js"],"sourcesContent":["(function () {\n(function() {\n    // Collapsible functionality\n    $('.card-header.clickable').on('click', function() {\n        const $card = $(this).closest('.collapsible');\n        const $content = $card.find('.card-content');\n        const $icon = $(this).find('.collapse-icon');\n        if ($card.hasClass('collapsed')) {\n            // Expand\n            $card.removeClass('collapsed').addClass('expanded');\n            $content.slideDown(300);\n            $icon.attr('data-lucide', 'chevron-up');\n        } else {\n            // Collapse\n            $card.removeClass('expanded').addClass('collapsed');\n            $content.slideUp(300);\n            $icon.attr('data-lucide', 'chevron-down');\n        }\n        // Recreate icons after changing data-lucide attribute\n        setTimeout(()=>{\n            lucide.createIcons();\n        }, 100);\n    });\n    /* ------------------------------------------------ */ const $chatContainer = $('.chat-messages');\n    // 打字效果：逐字顯示文字\n    function typeText($element, text, speed = 50) {\n        return new Promise((resolve)=>{\n            // 把字串丟給 DOMParser 解析成 DOM 結構\n            const parser = new DOMParser();\n            const doc = parser.parseFromString(`<div>${text}</div>`, \"text/html\");\n            const nodes = Array.from(doc.body.firstChild.childNodes);\n            let nodeIndex = 0;\n            let charIndex = 0;\n            function typeNext() {\n                if (nodeIndex >= nodes.length) {\n                    resolve();\n                    return;\n                }\n                const node = nodes[nodeIndex];\n                if (node.nodeType === Node.TEXT_NODE) {\n                    // 文字節點 → 逐字輸出\n                    const chars = node.textContent;\n                    if (charIndex < chars.length) {\n                        $element.html($element.html() + chars.charAt(charIndex));\n                        charIndex++;\n                        setTimeout(typeNext, speed);\n                    } else {\n                        nodeIndex++;\n                        charIndex = 0;\n                        typeNext();\n                    }\n                } else {\n                    // HTML 或 MathML → 整塊直接插入\n                    $element.append(node.cloneNode(true));\n                    nodeIndex++;\n                    typeNext();\n                }\n            }\n            typeNext();\n        });\n    }\n    // 播放音訊\n    function playAudio(src) {\n        return new Promise((resolve)=>{\n            const audio = new Audio(`audio/${src}`);\n            console.log(`Playing audio: audio/${src}`);\n            audio.onended = resolve;\n            audio.onerror = resolve; // 若音訊失敗也繼續流程\n            audio.play();\n        });\n    }\n    // 顯示一則訊息\n    async function showMessage(msg) {\n        const type = msg.speaker;\n        const $template = $(`.message-block.message-${type}`).first();\n        const $newMessage = $template.clone().hide();\n        const $textElement = $newMessage.find('p');\n        $textElement.text('');\n        $('.chat-messages').append($newMessage);\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        let typingPromise;\n        let audioPromise = Promise.resolve();\n        switch(type){\n            case 'UnvoicedNote':\n                $textElement.text(msg.text);\n                $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                typingPromise = new Promise((resolve)=>{\n                    $newMessage.fadeIn(300, resolve);\n                });\n                $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                break;\n            case 'Turi':\n                typingPromise = typeText($textElement, msg.text);\n                $newMessage.show();\n                $newMessage.find('.audio-icon').addClass('show');\n                $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                if (msg.audio) audioPromise = playAudio(msg.audio);\n                break;\n            case 'student':\n                $textElement.html(msg.text);\n                $newMessage.show();\n                $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                break;\n            default:\n                console.warn(`Unknown message type: ${type}`);\n                break;\n        }\n        await Promise.all([\n            typingPromise,\n            audioPromise\n        ]);\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        if (type === 'UnvoicedNote') await new Promise((resolve)=>setTimeout(resolve, 500));\n        else {\n            $newMessage.find('.audio-icon').addClass('pause');\n            await new Promise((resolve)=>setTimeout(resolve, 500));\n            $newMessage.find('.audio-icon').removeClass('show pause');\n        }\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        await new Promise((resolve)=>setTimeout(resolve, 1000));\n    }\n    // 顯示一組訊息（greeting、intro、feedback）\n    async function runLessonMessages(messages) {\n        if (!Array.isArray(messages) || messages.length === 0) return; // 沒東西就直接結束\n        for (const msg of messages){\n            if (msg.image) {\n                const $img = $('<img>', {\n                    class: 'concept-image',\n                    src: `images/${msg.image}`,\n                    alt: 'concept image'\n                });\n                $('.notes-section .card-content').empty();\n                $('.app-loader').removeClass('hidden').fadeIn(100);\n                setTimeout(()=>{\n                    $('.app-loader').fadeOut(200, ()=>{\n                        $('.notes-section .card-content').html($img).fadeIn(500);\n                    });\n                }, 300);\n            }\n            await showMessage(msg);\n        }\n    }\n    // 課程流程\n    async function runLesson(data) {\n        // 1. greeting\n        await runLessonMessages(data.greeting);\n        // 2. concepts\n        let currentConcept = 0;\n        async function runConcept(conceptIndex) {\n            const concept = data.concepts[conceptIndex];\n            // 3. intro\n            await runLessonMessages(concept.intro);\n            // 4. Choice\n            return new Promise((resolve)=>{\n                function showOptions(conceptIndex) {\n                    const concept = data.concepts[conceptIndex];\n                    // 4.1 Choice Button\n                    $('#choicePopup').empty();\n                    concept.options.forEach((option, i)=>{\n                        const $btn = $('<button>', {\n                            class: 'action-btn choice-btn',\n                            html: `<span class=\"choice\">${option.label}.</span>${option.text}`\n                        }).attr('data-concepts', conceptIndex).attr('data-options', i);\n                        if (option.isCorrect) $btn.data('correct', true);\n                        $('#choicePopup').append($btn);\n                        $('body').addClass('show-choice');\n                        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                    });\n                    // 5. Click\n                    $('.choice-btn').off('click').on('click', async function() {\n                        const c = $(this).data('concepts');\n                        const o = $(this).data('options');\n                        const option = data.concepts[c].options[o];\n                        // 5.1 hide choicePopup\n                        $('body').removeClass('show-choice');\n                        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                        // 5.2 play audio\n                        await playAudio('SFX_Select_01.mp3');\n                        // 5.3 show student Msg\n                        const studentMsg = [\n                            {\n                                speaker: 'student',\n                                text: `<span class=\"choice\">${option.label}.</span>${option.text}`\n                            }\n                        ];\n                        await runLessonMessages(studentMsg);\n                        // 5.4 feedback\n                        const turiFeedbacks = option.feedback.turi;\n                        const noteFeedbacks = option.feedback.note;\n                        let messagesToShow = [];\n                        if (Array.isArray(turiFeedbacks) && turiFeedbacks.length > 0) {\n                            const randomTuri = turiFeedbacks[Math.floor(Math.random() * turiFeedbacks.length)];\n                            messagesToShow.push(randomTuri);\n                        }\n                        if (Array.isArray(noteFeedbacks) && noteFeedbacks.length > 0) messagesToShow = messagesToShow.concat(noteFeedbacks);\n                        await runLessonMessages(messagesToShow);\n                        // 5.5 isCorrect\n                        if (option.isCorrect) {\n                            // ✅\n                            currentConcept++;\n                            if (currentConcept < data.concepts.length) {\n                                await runConcept(currentConcept);\n                                resolve();\n                            } else resolve();\n                        } else {\n                            // ❌\n                            await runLessonMessages(concept.reteach);\n                            await runLessonMessages(concept.redo);\n                            showOptions(conceptIndex);\n                            $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n                        }\n                    });\n                }\n                showOptions(conceptIndex);\n            });\n        }\n        // 2. concepts\n        await runConcept(currentConcept);\n        // 3. End\n        await runLessonMessages(data.close);\n    }\n    /* ------------------------------------------------ */ // 啟動流程\n    $('#startLessonBtn').on('click', function() {\n        $('#startPopup').hide();\n        setTimeout(()=>{\n            runLesson(lessonData); // ✅ 修正：傳整個 lessonData\n        }, 500);\n    });\n    /* ------------------------------------------------ */ // Action button interactions\n    $('.action-btn, .menu-btn').on('click', function() {\n        const buttonText = $(this).text().trim();\n        // Add visual feedback\n        $(this).addClass('active');\n        setTimeout(()=>{\n            $(this).removeClass('active');\n        }, 200);\n    });\n    // Handle window resize to maintain layout\n    $(window).on('resize', function() {\n        // Ensure proper height calculations on resize\n        const windowHeight = $(window).height();\n        const headerHeight = $('.header').outerHeight();\n        const remainingHeight = windowHeight - headerHeight;\n        $('.main-content').css('height', remainingHeight + 'px');\n    });\n    // Initial height calculation\n    $(window).trigger('resize');\n})();\n\n})();\n//# sourceMappingURL=main.js.map\n","(function () {\n\n  // Collapsible functionality\n  $('.card-header.clickable').on('click', function () {\n    const $card = $(this).closest('.collapsible');\n    const $content = $card.find('.card-content');\n    const $icon = $(this).find('.collapse-icon');\n\n    if ($card.hasClass('collapsed')) {\n      // Expand\n      $card.removeClass('collapsed').addClass('expanded');\n      $content.slideDown(300);\n      $icon.attr('data-lucide', 'chevron-up');\n    } else {\n      // Collapse\n      $card.removeClass('expanded').addClass('collapsed');\n      $content.slideUp(300);\n      $icon.attr('data-lucide', 'chevron-down');\n    }\n\n    // Recreate icons after changing data-lucide attribute\n    setTimeout(() => {\n        lucide.createIcons();\n      }, 100);\n  });\n\n  /* ------------------------------------------------ */\n\n  const $chatContainer = $('.chat-messages');\n  // 打字效果：逐字顯示文字\n  function typeText($element, text, speed = 50) {\n    return new Promise(resolve => {\n      // 把字串丟給 DOMParser 解析成 DOM 結構\n      const parser = new DOMParser();\n      const doc = parser.parseFromString(`<div>${text}</div>`, \"text/html\");\n      const nodes = Array.from(doc.body.firstChild.childNodes);\n\n      let nodeIndex = 0;\n      let charIndex = 0;\n\n      function typeNext() {\n        if (nodeIndex >= nodes.length) {\n          resolve();\n          return;\n        }\n\n        const node = nodes[nodeIndex];\n\n        if (node.nodeType === Node.TEXT_NODE) {\n          // 文字節點 → 逐字輸出\n          const chars = node.textContent;\n          if (charIndex < chars.length) {\n            $element.html($element.html() + chars.charAt(charIndex));\n            charIndex++;\n            setTimeout(typeNext, speed);\n          } else {\n            nodeIndex++;\n            charIndex = 0;\n            typeNext();\n          }\n        } else {\n          // HTML 或 MathML → 整塊直接插入\n          $element.append(node.cloneNode(true));\n          nodeIndex++;\n          typeNext();\n        }\n      }\n\n      typeNext();\n    });\n  }\n  \n\n  // 播放音訊\n  function playAudio(src) {\n    return new Promise(resolve => {\n      const audio = new Audio(`audio/${src}`);\n      console.log(`Playing audio: audio/${src}`);\n      audio.onended = resolve;\n      audio.onerror = resolve; // 若音訊失敗也繼續流程\n      audio.play();\n    });\n  }\n\n  // 顯示一則訊息\n  async function showMessage(msg) {\n    const type = msg.speaker;\n    const $template = $(`.message-block.message-${type}`).first();\n    const $newMessage = $template.clone().hide();\n    const $textElement = $newMessage.find('p');\n\n    $textElement.text('');\n    $('.chat-messages').append($newMessage);\n    $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n\n    let typingPromise;\n    let audioPromise = Promise.resolve();\n\n    switch (type) {\n      case 'UnvoicedNote':\n        $textElement.text(msg.text);\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        typingPromise = new Promise(resolve => {\n          $newMessage.fadeIn(300, resolve);\n        });\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        break;\n\n      case 'Turi':\n        typingPromise = typeText($textElement, msg.text);  \n        $newMessage.show();\n        $newMessage.find('.audio-icon').addClass('show');\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        if (msg.audio) {\n          audioPromise = playAudio(msg.audio);\n        }\n        break;\n\n      case 'student':\n        $textElement.html(msg.text);\n        $newMessage.show();\n        $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n        break;\n\n      default:\n        console.warn(`Unknown message type: ${type}`);\n        break;\n    }\n\n    await Promise.all([typingPromise, audioPromise]);\n\n    $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n\n    if (type === 'UnvoicedNote') {\n      await new Promise(resolve => setTimeout(resolve, 500));\n    } else {\n      $newMessage.find('.audio-icon').addClass('pause');\n      await new Promise(resolve => setTimeout(resolve, 500));\n      $newMessage.find('.audio-icon').removeClass('show pause');\n    }\n\n    $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n\n    await new Promise(resolve => setTimeout(resolve, 1000));\n  }\n\n  // 顯示一組訊息（greeting、intro、feedback）\n  async function runLessonMessages(messages) {\n    if (!Array.isArray(messages) || messages.length === 0) {\n      return; // 沒東西就直接結束\n    }\n    for (const msg of messages) {\n      if (msg.image) {\n        const $img = $('<img>', {\n          class: 'concept-image',\n          src: `images/${msg.image}`,\n          alt: 'concept image'\n        });\n        $('.notes-section .card-content').empty();\n        $('.app-loader').removeClass('hidden').fadeIn(100);\n        setTimeout(() => {\n          $('.app-loader').fadeOut(200, () => {\n            $('.notes-section .card-content').html($img).fadeIn(500);\n          });\n        }, 300);\n      }\n      await showMessage(msg);\n    }\n  }  \n\n  // 課程流程\n\n\n\n  async function runLesson(data) {\n    // 1. greeting\n    await runLessonMessages(data.greeting);\n\n    // 2. concepts\n    let currentConcept = 0;\n    async function runConcept(conceptIndex) {\n      const concept = data.concepts[conceptIndex];\n      // 3. intro\n      await runLessonMessages(concept.intro);\n\n      // 4. Choice\n      return new Promise(resolve => {\n        function showOptions(conceptIndex) {\n          const concept = data.concepts[conceptIndex];\n\n          // 4.1 Choice Button\n          $('#choicePopup').empty();\n          concept.options.forEach((option, i) => {\n            const $btn = $('<button>', {\n              class: 'action-btn choice-btn',\n              html: `<span class=\"choice\">${option.label}.</span>${option.text}`\n            }).attr('data-concepts', conceptIndex)\n              .attr('data-options', i);\n            if (option.isCorrect) {\n              $btn.data('correct', true);\n            }\n            $('#choicePopup').append($btn);\n            $('body').addClass('show-choice');\n            $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n          });\n\n          // 5. Click\n          $('.choice-btn').off('click').on('click', async function () {\n            const c = $(this).data('concepts');\n            const o = $(this).data('options');\n            const option = data.concepts[c].options[o];\n\n            // 5.1 hide choicePopup\n            $('body').removeClass('show-choice');\n            $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n\n            // 5.2 play audio\n            await playAudio('SFX_Select_01.mp3');\n\n            // 5.3 show student Msg\n            const studentMsg = [{\n              speaker: 'student',\n              text: `<span class=\"choice\">${option.label}.</span>${option.text}`,\n            }];\n            await runLessonMessages(studentMsg);\n\n            // 5.4 feedback\n            const turiFeedbacks = option.feedback.turi;\n            const noteFeedbacks = option.feedback.note;\n\n            let messagesToShow = [];\n            if (Array.isArray(turiFeedbacks) && turiFeedbacks.length > 0) {\n              const randomTuri = turiFeedbacks[Math.floor(Math.random() * turiFeedbacks.length)];\n              messagesToShow.push(randomTuri);\n            }\n            if (Array.isArray(noteFeedbacks) && noteFeedbacks.length > 0) {\n              messagesToShow = messagesToShow.concat(noteFeedbacks);\n            }\n            await runLessonMessages(messagesToShow);\n\n            // 5.5 isCorrect\n            if (option.isCorrect) {\n              // ✅\n              currentConcept++;\n              if (currentConcept < data.concepts.length) {\n                await runConcept(currentConcept);\n                resolve();\n              } else {\n                resolve();\n              }\n            } else {\n              // ❌\n              await runLessonMessages(concept.reteach);\n              await runLessonMessages(concept.redo);\n              showOptions(conceptIndex);\n              $chatContainer.scrollTop($chatContainer[0].scrollHeight);\n            }\n          });\n        }\n        showOptions(conceptIndex);\n      });\n    }\n\n    // 2. concepts\n    await runConcept(currentConcept);\n\n    // 3. End\n    await runLessonMessages(data.close);\n  }\n\n  /* ------------------------------------------------ */\n\n  // 啟動流程\n  $('#startLessonBtn').on('click', function () {\n    $('#startPopup').hide();\n    setTimeout(() => {\n      runLesson(lessonData); // ✅ 修正：傳整個 lessonData\n    }, 500);\n  });\n    \n  /* ------------------------------------------------ */\n\n  // Action button interactions\n  $('.action-btn, .menu-btn').on('click', function () {\n    const buttonText = $(this).text().trim();\n    // Add visual feedback\n    $(this).addClass('active');\n    setTimeout(() => {\n      $(this).removeClass('active');\n    }, 200);\n  });\n\n  // Handle window resize to maintain layout\n  $(window).on('resize', function () {\n    // Ensure proper height calculations on resize\n    const windowHeight = $(window).height();\n    const headerHeight = $('.header').outerHeight();\n    const remainingHeight = windowHeight - headerHeight;\n    $('.main-content').css('height', remainingHeight + 'px');\n  });\n\n  // Initial height calculation\n  $(window).trigger('resize');\n})();"],"names":["$","on","$card","closest","$content","find","$icon","hasClass","removeClass","addClass","slideDown","attr","slideUp","setTimeout","lucide","createIcons","$chatContainer","playAudio","src","Promise","resolve","audio","Audio","console","log","onended","onerror","play","showMessage","msg","typingPromise","type","speaker","$newMessage","$template","first","clone","hide","$textElement","text","append","scrollTop","scrollHeight","audioPromise","fadeIn","typeText","$element","speed","nodes","Array","from","doc","parser","DOMParser","parseFromString","body","firstChild","childNodes","nodeIndex","charIndex","typeNext","length","node","nodeType","Node","TEXT_NODE","chars","textContent","html","charAt","cloneNode","show","warn","all","runLessonMessages","messages","isArray","image","$img","class","alt","empty","fadeOut","runLesson","data","greeting","currentConcept","runConcept","conceptIndex","concept","concepts","intro","showOptions","options","forEach","option","i","$btn","label","isCorrect","off","c","o","studentMsg","turiFeedbacks","feedback","turi","noteFeedbacks","note","messagesToShow","randomTuri","Math","floor","random","push","concat","reteach","redo","close","lessonData","trim","window","windowHeight","height","headerHeight","outerHeight","css","remainingHeight","trigger"],"version":3,"file":"main.js.map"}